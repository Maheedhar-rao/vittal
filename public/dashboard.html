<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vittal ‚Äì Email & Document Tracking Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        system-ui, -system-ui, "Segoe UI", Roboto, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #1e293b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: radial-gradient(circle at top left, #1e3a8a, #020617 55%);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header h1 span.logo {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: linear-gradient(135deg, #6366f1, #22c55e);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    header .meta {
      font-size: 12px;
      color: #9ca3af;
      text-align: right;
    }
    main {
      padding: 16px 24px 32px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(290px, 1.3fr);
      gap: 20px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid #1e293b;
      padding: 16px 18px;
      box-shadow: 0 18px 35px rgba(0,0,0,0.35);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .card-header h2 {
      margin: 0;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #1d4ed8;
      background: rgba(37, 99, 235, 0.12);
      color: #bfdbfe;
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.2);
    }
    .table-wrap {
      overflow-x: auto;
      margin-top: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 700px;
    }
    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #020617;
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    tbody tr:hover {
      background: rgba(15,23,42,0.85);
    }
    .email-recipient {
      font-weight: 500;
    }
    .email-recipient small {
      display: block;
      font-size: 11px;
      color: #9ca3af;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #1f2937;
      background: #020617;
    }
    .badge-open {
      border-color: rgba(34,197,94,0.6);
      background: rgba(22,163,74,0.15);
      color: #bbf7d0;
    }
    .badge-cold {
      border-color: rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.8);
      color: #cbd5f5;
    }
    .badge-alert {
      border-color: rgba(248,113,113,0.8);
      background: rgba(127,29,29,0.6);
      color: #fecaca;
    }
    .tiny {
      font-size: 11px;
      color: #9ca3af;
    }
    .stat-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .stat-pill {
      font-size: 11px;
      color: #9ca3af;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .stat-pill strong {
      color: #e5e7eb;
      font-weight: 500;
    }
    .alerts-list {
      max-height: 360px;
      overflow-y: auto;
      margin-top: 8px;
      padding-right: 4px;
    }
    .alert-item {
      border-radius: 10px;
      border: 1px solid #1e293b;
      padding: 8px 9px;
      margin-bottom: 8px;
      background: rgba(15,23,42,0.9);
      font-size: 12px;
    }
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .alert-type {
      font-weight: 500;
      font-size: 11px;
    }
    .alert-severity {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #f97316;
      background: rgba(248,113,113,0.1);
      color: #fed7aa;
    }
    .alert-timestamp {
      font-size: 11px;
      color: #9ca3af;
    }
    .empty {
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }
    .footer {
      margin-top: 10px;
      font-size: 11px;
      color: #6b7280;
    }
    .pill-muted {
      border-color: #374151;
      background: rgba(15,23,42,0.8);
      color: #9ca3af;
    }
    .filters {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
    }
    .filters input {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1e293b;
      padding: 5px 8px;
      color: #e5e7eb;
      font-size: 12px;
      min-width: 170px;
    }
    .filters input::placeholder {
      color: #6b7280;
    }
    .filters button {
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      padding: 4px 9px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .filters button:hover {
      background: #111827;
    }
  </style>
</head>
<body>
  <header>
    <h1>
      <span class="logo">V</span>
      Vittal Activity Console
    </h1>
    <div class="meta">
      <div id="health-status">Connecting‚Ä¶</div>
      <div class="tiny" id="health-stats"></div>
    </div>
  </header>

  <main>
    <!-- LEFT: Emails table -->
    <section class="card">
      <div class="card-header">
        <h2>Sent Emails & Activity</h2>
        <div class="filters">
          <input id="search-input" placeholder="Filter by email or subject‚Ä¶" />
          <button id="refresh-btn">‚Üª Refresh</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Recipient</th>
              <th>Subject</th>
              <th>Document</th>
              <th>Sent</th>
              <th>Engagement</th>
              <th>Activity</th>
            </tr>
          </thead>
          <tbody id="emails-tbody">
            <!-- rows injected by JS -->
          </tbody>
        </table>
      </div>
      <div class="footer">
        Live data pulled from <code>/api/emails</code> and updated via WebSocket.
      </div>
    </section>

    <!-- RIGHT: Alerts & live status -->
    <section class="card">
      <div class="card-header">
        <h2>
          Alerts & Risk
          <span class="pill pill-muted" id="ws-pill">
            <span class="pill-dot" id="ws-dot"></span>
            Live feed
          </span>
        </h2>
      </div>
      <div class="alerts-list" id="alerts-list">
        <!-- alerts injected by JS -->
      </div>
      <div class="footer">
        High-risk actions (downloads, prints, unauthorized forwards) are
        surfaced here in real-time.
      </div>
    </section>
  </main>

  <script>
    const emailsTbody = document.getElementById('emails-tbody');
    const healthStatusEl = document.getElementById('health-status');
    const healthStatsEl = document.getElementById('health-stats');
    const alertsListEl = document.getElementById('alerts-list');
    const wsDot = document.getElementById('ws-dot');
    const wsPill = document.getElementById('ws-pill');
    const searchInput = document.getElementById('search-input');
    const refreshBtn = document.getElementById('refresh-btn');

    let allEmails = [];
    let allAlerts = [];

    function fmtDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function fmtShortDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) +
          ' ¬∑ ' +
          d.toLocaleDateString();
      } catch {
        return iso;
      }
    }

    function renderEmails() {
      const filter = (searchInput.value || '').trim().toLowerCase();
      const rows = [];

      const data = filter
        ? allEmails.filter(e =>
            (e.recipientEmail || '').toLowerCase().includes(filter) ||
            (e.recipientName || '').toLowerCase().includes(filter) ||
            (e.subject || '').toLowerCase().includes(filter)
          )
        : allEmails;

      if (!data.length) {
        rows.push(
          '<tr><td colspan="6" class="empty">No emails found yet. Send a tracked email to see it here.</td></tr>'
        );
      } else {
        for (const e of data) {
          const hasOpens = (e.openCount || 0) > 0;
          const hasHighRisk = (e.downloadCount || 0) > 0 || (e.printCount || 0) > 0 || (e.forwardCount || 0) > 0;

          let statusBadge = '<span class="badge badge-cold">No opens yet</span>';
          if (hasOpens && !hasHighRisk) {
            statusBadge = '<span class="badge badge-open">Engaged</span>';
          } else if (hasHighRisk) {
            statusBadge = '<span class="badge badge-alert">High risk</span>';
          }

          rows.push(`
            <tr>
              <td class="email-recipient">
                ${e.recipientName || e.recipientEmail || 'Unknown'}
                <small>${e.recipientEmail || ''}</small>
              </td>
              <td>${e.subject || '‚Äî'}</td>
              <td>
                ${e.documentName || '‚Äî'}
                <div class="tiny">${e.documentId}</div>
              </td>
              <td>
                ${fmtShortDate(e.sentAt)}
              </td>
              <td>
                ${statusBadge}
                <div class="tiny">
                  Opens: <strong>${e.openCount || 0}</strong><br/>
                  Last open: ${fmtShortDate(e.lastOpenAt)}
                </div>
              </td>
              <td>
                <div class="stat-row">
                  <span class="stat-pill">‚¨áÔ∏è <strong>${e.downloadCount || 0}</strong> downloads</span>
                  <span class="stat-pill">üñ®Ô∏è <strong>${e.printCount || 0}</strong> prints</span>
                  <span class="stat-pill">üì§ <strong>${e.forwardCount || 0}</strong> forwards</span>
                </div>
              </td>
            </tr>
          `);
        }
      }

      emailsTbody.innerHTML = rows.join('');
    }

    function renderAlerts() {
      const rows = [];
      if (!allAlerts.length) {
        rows.push('<div class="empty">No alerts yet. High-risk actions will appear here.</div>');
      } else {
        for (const a of allAlerts) {
          rows.push(`
            <div class="alert-item">
              <div class="alert-header">
                <div class="alert-type">${a.type || 'ALERT'}</div>
                <div class="alert-severity">${(a.severity || '').toUpperCase()}</div>
              </div>
              <div>${a.message || ''}</div>
              <div class="alert-timestamp">
                ${fmtShortDate(a.createdAt || a.timestamp)} ¬∑ doc
                <code>${(a.event && a.event.documentId) || a.documentId || 'n/a'}</code>
              </div>
            </div>
          `);
        }
      }
      alertsListEl.innerHTML = rows.join('');
    }

    async function loadEmails() {
      try {
        const res = await fetch('/api/emails');
        const data = await res.json();
        allEmails = data.emails || [];
        renderEmails();
      } catch (e) {
        console.error('Failed to load emails', e);
      }
    }

    async function loadAlerts() {
      try {
        const res = await fetch('/api/alerts');
        const data = await res.json();
        allAlerts = (data.alerts || []).slice(0, 50);
        renderAlerts();
      } catch (e) {
        console.error('Failed to load alerts', e);
      }
    }

    async function loadHealth() {
      try {
        const res = await fetch('/api/health');
        const data = await res.json();
        healthStatusEl.textContent = data.status === 'ok' ? 'Online' : 'Degraded';
        const s = data.stats || {};
        healthStatsEl.textContent = `Events: ${s.totalEvents || 0} ‚Ä¢ Alerts: ${s.totalAlerts || 0} ‚Ä¢ Incidents: ${s.totalIncidents || 0}`;
      } catch (e) {
        console.error('Failed to load health', e);
        healthStatusEl.textContent = 'Offline';
      }
    }

    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = protocol + '//' + window.location.host;

      const ws = new WebSocket(wsUrl);

      ws.addEventListener('open', () => {
        wsDot.style.backgroundColor = '#22c55e';
        wsPill.classList.remove('pill-muted');
        healthStatusEl.textContent = 'Online ¬∑ Live';
      });

      ws.addEventListener('close', () => {
        wsDot.style.backgroundColor = '#f97316';
        wsPill.classList.add('pill-muted');
        healthStatusEl.textContent = 'Online ¬∑ Live feed lost';
        // retry after a delay
        setTimeout(connectWebSocket, 4000);
      });

      ws.addEventListener('message', (event) => {
        try {
          const msg = JSON.parse(event.data);

          // On any tracking-related event, refresh emails & alerts
          const interestingTypes = new Set([
            'TRACKING_EVENT',
            'DOCUMENT_OPENED',
            'PAGE_VIEWED',
            'DOWNLOAD_ALERT',
            'CRITICAL_ALERT',
            'UNAUTHORIZED_SHARE_ALERT',
            'ANOMALY_DETECTED',
          ]);

          if (msg.type && interestingTypes.has(msg.type)) {
            loadEmails();
            loadAlerts();
            loadHealth();
          }
        } catch (e) {
          console.warn('WS message parse error', e);
        }
      });
    }

    searchInput.addEventListener('input', () => {
      renderEmails();
    });

    refreshBtn.addEventListener('click', () => {
      loadEmails();
      loadAlerts();
      loadHealth();
    });

    // Initial load
    loadEmails();
    loadAlerts();
    loadHealth();
    connectWebSocket();
  </script>
</body>
</html>
